@startuml
title Use Case 2: Log Food via Barcode

actor User
participant "Frontend\n(Android)" as Frontend
participant "ML Kit\nBarcode Scanner" as MLKit
participant "FridgeController" as Controller
participant "Open Food Facts\nAPI" as OpenFood
participant "FoodTypeModel" as FoodTypeModel
participant "FoodItemModel" as FoodItemModel
database "MongoDB" as DB

User -> Frontend: Clicks "Add Food"\nand chooses barcode option
activate Frontend
Frontend -> Frontend: Opens camera scanner\nwith back button
User -> Frontend: Positions barcode in view

Frontend -> MLKit: Scan barcode from camera frame
activate MLKit
MLKit --> Frontend: Barcode detected (once)\nbarcodeId: "123456789"
deactivate MLKit

Frontend -> Controller: POST /api/fridge/barcode\n{barcode: "123456789",\nAuthorization: Bearer <JWT>}
activate Controller

Controller -> FoodTypeModel: findByBarcode("123456789")
activate FoodTypeModel
FoodTypeModel -> DB: db.foodtypes.findOne({barcodeId: "123456789"})
activate DB
DB --> FoodTypeModel: FoodType or null
deactivate DB

alt FoodType exists in database
    FoodTypeModel --> Controller: Existing FoodType(id, name, nutrients, barcodeId, shelfLifeDays)
    deactivate FoodTypeModel
else FoodType not in database
    FoodTypeModel --> Controller: null
    deactivate FoodTypeModel
    Controller -> OpenFood: GET /api/v0/product/123456789.json
    activate OpenFood
    OpenFood --> Controller: Product data\n{product: {product_name, brands,\nnutriments, image_url}}
    deactivate OpenFood

    Controller -> FoodTypeModel: create({name, barcodeId, nutrients, shelfLifeDays, brand, image})
    activate FoodTypeModel
    FoodTypeModel -> DB: db.foodtypes.insertOne(\n{name: "Product Name",\nbarcodeId: "123456789",\nnutrients: {...}, shelfLifeDays: 7})
    activate DB
    DB --> FoodTypeModel: New FoodType document
    deactivate DB
    FoodTypeModel --> Controller: New FoodType(id, name, nutrients, barcodeId)
    deactivate FoodTypeModel
end

Controller -> FoodItemModel: create({userId, typeId, expirationDate, percentLeft: 100})
activate FoodItemModel
FoodItemModel -> DB: db.fooditems.insertOne(\n{userId, typeId,\nexpirationDate: now + shelfLifeDays,\npercentLeft: 100})
activate DB
DB --> FoodItemModel: Created FoodItem document
deactivate DB
FoodItemModel --> Controller: FoodItem(id, userId, typeId, expirationDate, percentLeft)
deactivate FoodItemModel

Controller -> FoodItemModel: getAssociatedFoodType(foodItem)
activate FoodItemModel
FoodItemModel -> FoodTypeModel: findById(typeId)
activate FoodTypeModel
FoodTypeModel -> DB: db.foodtypes.findOne({_id: typeId})
activate DB
DB --> FoodTypeModel: FoodType document
deactivate DB
FoodTypeModel --> FoodItemModel: FoodType(name, nutrients, image, shelfLifeDays)
deactivate FoodTypeModel
FoodItemModel --> Controller: Complete FridgeItem data\n{foodItem + foodType}
deactivate FoodItemModel

Controller --> Frontend: 200 OK\nFridgeItem\n{id, name, brand, nutrients,\nimage, expirationDate, percentLeft}
deactivate Controller
Frontend --> User: Display confirmation screen\nwith product info and image
User -> Frontend: Reviews and clicks "Confirm"
Frontend -> Frontend: Navigate to fridge screen\nrefresh fridge list
Frontend --> User: Show item in fridge inventory
deactivate Frontend

note right of Frontend
  Back button allows user
  to cancel at any time
end note

@enduml
