@startuml
title Use Case 4: Generate Recipe Suggestions

actor User
participant "Frontend" as Frontend
participant "Recipe" as Controller
participant "TheMealDB API" as MealDB
participant "AiRecipe" as AiRecipe
participant "Gemini API" as Gemini

User -> Frontend: Selects items from fridge\n(e.g., apple, chicken, rice)
activate Frontend
Frontend --> User: Show selected items highlighted
User -> Frontend: Clicks "Find Recipes"\nin bottom corner

== Recipe Via API (Default) ==
Frontend -> Controller: GET /api/recipes?ingredients=apple,chicken,rice\n(Authorization: Bearer <JWT>)
activate Controller

Controller -> Controller: Parse query params\ningredients = ["apple", "chicken", "rice"]

loop For each selected ingredient
    Controller -> MealDB: GET /api/json/v1/1/filter.php?i={ingredient}
    activate MealDB
    MealDB --> Controller: JSON response\n{meals: [{idMeal, strMeal, strMealThumb}]}
    deactivate MealDB
end

Controller -> Controller: Aggregate recipes\nFilter by matching ≥2 ingredients\nLimit to top 3 recipes

alt Recipes found (≥1 recipe matches)
    Controller --> Controller: RecipeResult[]\n{id, title, thumbnail, sourceUrl}
    Controller --> Frontend: 200 OK\n{recipes: [3 recipe summaries with links]}
    deactivate Controller
    Frontend --> User: Display recipe dropdown\nwith 3 recipe cards
    User -> Frontend: Clicks on recipe card
    Frontend --> User: Open external link in browser\n(TheMealDB recipe details)
else No recipes found
    Controller --> Controller: Empty array []
    Controller --> Frontend: 404 Not Found\n{error: "No matching recipes"}
    deactivate Controller
    Frontend --> User: Display message:\n"No recipes found,\ntry different ingredients"
end
deactivate Frontend

== Recipe Via AI (User toggles AI) ==
User -> Frontend: Toggles "AI Recipe" option ON
activate Frontend
User -> Frontend: Clicks "Find Recipes"
Frontend -> Controller: POST /api/recipes/generate\n{ingredients: ["apple", "chicken", "rice"],\nAuthorization: Bearer <JWT>}
activate Controller

Controller -> AiRecipe: generateRecipe(ingredients)
activate AiRecipe
AiRecipe -> AiRecipe: Format ingredients as TOML:\ningredients = ["apple", "chicken", "rice"]
AiRecipe -> Gemini: POST /v1beta/models/gemini-2.5-flash:generateContent\n{contents: [{parts: [{text: prompt}]}]}\nprompt includes TOML ingredient list
activate Gemini
Gemini --> AiRecipe: JSON response\n{candidates: [{content: {parts: [{text: markdown_recipe}]}}]}
deactivate Gemini
AiRecipe -> AiRecipe: Extract markdown recipe from response
AiRecipe --> Controller: Markdown recipe string\n(title, ingredients, steps, serving)
deactivate AiRecipe

Controller --> Frontend: 200 OK\n{recipe: "# Recipe Title\n## Ingredients\n...",\nformat: "markdown"}
deactivate Controller
Frontend --> User: Display AI recipe\nin markdown preview
User -> Frontend: Clicks on AI recipe
Frontend --> User: Show full recipe with\nformatted instructions
deactivate Frontend

note right of Gemini
  Gemini generates creative,
  personalized recipes with:
  - Recipe title
  - Complete ingredient list
  - Step-by-step instructions
  - Cooking time estimate
  - Serving suggestions
  Uses TOML format for
  structured ingredient input
end note

@enduml
