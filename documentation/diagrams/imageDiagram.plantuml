@startuml
title Use Case 1: Log Food via Image

actor User
participant "Frontend" as Frontend
participant "Media" as Controller
participant "AiVision" as AiVision
participant "Gemini API" as Gemini
participant "FoodType" as FoodTypeModel
participant "FoodItem" as FoodItemModel
database "MongoDB" as DB

User -> Frontend: Selects "Add Food"\nand chooses image option
activate Frontend
Frontend -> Frontend: Opens camera
User -> Frontend: Takes photo of food item
Frontend -> Controller: POST /api/media/analyze-produce\n(multipart/form-data: image,\nAuthorization: Bearer <JWT>)
activate Controller

Controller -> AiVision: analyzeProduce(imagePath)
activate AiVision
AiVision -> AiVision: Read image file\nEncode to base64
AiVision -> Gemini: POST /v1beta/models/gemini-2.5-flash:generateContent\n(base64 image data,\nprompt: "Identify this produce")
activate Gemini
Gemini --> AiVision: JSON response\n{name: "apple", category: "fruit",\nconfidence: 0.95, nutrients: {...}}
deactivate Gemini
AiVision --> Controller: ProduceAnalysis\n(name, category, nutrients)
deactivate AiVision

alt High confidence identification (confidence â‰¥ 0.90)
    Controller -> FoodTypeModel: findByName(name)
    activate FoodTypeModel
    FoodTypeModel -> DB: db.foodtypes.findOne({name: "apple"})
    activate DB
    DB --> FoodTypeModel: FoodType or null
    deactivate DB

    alt FoodType exists
        FoodTypeModel --> Controller: Existing FoodType(id, name, nutrients)
        deactivate FoodTypeModel
    else FoodType not found
        FoodTypeModel --> Controller: null
        deactivate FoodTypeModel
        Controller -> FoodTypeModel: create({name, nutrients, shelfLifeDays})
        activate FoodTypeModel
        FoodTypeModel -> DB: db.foodtypes.insertOne({name: "apple", nutrients: {...}})
        activate DB
        DB --> FoodTypeModel: Created FoodType document
        deactivate DB
        FoodTypeModel --> Controller: New FoodType(id, name, nutrients)
        deactivate FoodTypeModel
    end

    Controller -> FoodItemModel: create({userId, typeId, expirationDate, percentLeft: 100})
    activate FoodItemModel
    FoodItemModel -> DB: db.fooditems.insertOne(\n{userId, typeId, expirationDate, percentLeft: 100})
    activate DB
    DB --> FoodItemModel: Created FoodItem document
    deactivate DB
    FoodItemModel --> Controller: FoodItem(id, userId, typeId, expirationDate)
    deactivate FoodItemModel

    Controller --> Frontend: 200 OK\nFridgeItem\n{id, name, nutrients, expirationDate, percentLeft, image}
    deactivate Controller
    Frontend --> User: Display confirmation screen\nwith identified food details
    User -> Frontend: Clicks "Confirm"
    Frontend -> Frontend: Navigate to fridge screen
    Frontend --> User: Show updated fridge list\nwith new item

else Low confidence or not food (confidence < 0.90)
    Controller --> Frontend: 400 Bad Request\n{error: "Cannot identify food item",\nconfidence: 0.45}
    deactivate Controller
    Frontend --> User: Display error:\n"Could not identify food"\nOffer alternative methods\n(barcode scan or manual selection)
end
deactivate Frontend

@enduml
